!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.whatstpl=e():t.whatstpl=e()}(this,function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i.w={},i(i.s=6)}([function(t,e,i){"use strict";function n(t){if("/"==t)return t;let i=t.replace(/\\/g,"/").lastIndexOf("/");return i<0||"/"==t?".":i==t.length-1?n(t.substring(0,i)):t.substring(0,i).replace(/\/|\\/g,e.Separator)}function s(t,e=""){let i=n(t),s="./"==i&&null==t.match(/^\.[\/\\]/)?t:t.substring(i.length+1);if(e){let t=s.lastIndexOf(e);s=t>=0?s.substring(0,t):s}return s}function o(t){let i=t.split(/\/|\\/);for(let t=0;t<i.length;t++)".."==i[t]?(i.splice(t-1,2),t-=2):"."==i[t]&&(i.splice(t,1),t-=1);return i.join(e.Separator)}function l(){return e.IsBrowser?location.protocol+"//"+location.host+n(location.pathname):process.cwd()}function r(t){return"/"==t[0]||null!=t.match(/^[a-zA-Z0-9]+:[\/\\]/)}Object.defineProperty(e,"__esModule",{value:!0}),e.IsBrowser="object"==typeof window&&"function"==typeof XMLHttpRequest,e.Separator=e.IsBrowser?"/":"win32"==process.platform?"\\":"/",e.escape=function(t){return String(t).replace(/<\/?[^>]*>/g,"")},e.dirname=n,e.basename=s,e.extname=function(t){let e=s(t),i=e.lastIndexOf(".");return i>=0?e.substring(i):""},e.normalizePath=o,e.getCwd=l,e.isAbsPath=r,e.getAbsPath=function(t){if(!r(t)){let i=l();t=i+("/"==i[i.length-1]?"":e.Separator)+t}return o(t)},e.getObjectValues=function(t){let e=[];for(let i in t)t.hasOwnProperty(i)&&e.push(t[i]);return e},e.getFunctionBodyOffset=function(t){let e=t.toString(),i=e.indexOf("{")+1,n=e.slice(0,i).split("\n"),s="\n"==e[i],o=s?0:n[n.length-1].indexOf("{")+2;return{line:s?n.length:n.length-1,column:o}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.UnclosedTagError=class extends SyntaxError{constructor(t,e,i,n){super(t),this.filename=e,this.line=i,this.column=n}}},function(t,e,i){"use strict";function n(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}Object.defineProperty(e,"__esModule",{value:!0}),n(i(1)),n(i(5)),n(i(0))},function(t,e){t.exports=require("fs")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(2);class s{constructor(t){this.children={},this.sourceMap={},this.id=this.filename=n.normalizePath(t),this.dirname=n.dirname(t),this.code=""}require(t,e={},i=""){let l=n.isAbsPath(t)||"."==this.dirname?t:n.normalizePath(this.dirname+"/"+t),r=n.dirname(l);if(s.cache[l]){let t=s.cache[l],a={default:""},u=(e,i={},n="")=>t.require(e,i,n);return this.children[l]=t,function(t,e,i){let n=Object.keys(i).join(", ");try{return new Function(o+(n?", "+n:""),e)}catch(e){if(e instanceof SyntaxError){e.message="Unexpected token found";let i=e.stack.split("\n");throw i[1]=i[1].replace("<anonymous>",t),e.stack=i.join("\n"),e}throw h(e,t)}}(this.filename,t.code,e).call(a,u,l,r,i,e,n.escape,...n.getObjectValues(e)),a}throw new Error("the request module hasn't been imported!")}}s.cache={},s.sourceMaps={},e.Module=s;const o="require, __filename, __dirname, __contents, __locals, __escape",l=/at ([a-zA-Z0-9_\.]+) \(eval at.+<anonymous>:(\d+:\d+)\)/,r=/const __module_\d+ = require\('(.+?)'/,a=/([a-zA-Z0-9_]+).call\(this.*\)/,u=n.getFunctionBodyOffset(new Function("a, b","a + b"));function c(t,e){let i,n,s=t.split("\n"),o=function(t){let e=t.match(a);return e?e[1]:""}(s[e-1]);if(!o)return(n=(i=s[e-1])&&i.match(r))?n[1].replace(/\\\\/g,"\\"):"";{let t,e,i=new RegExp(`const ${o} = (__module_\\d+).`);for(let o in s)if(n=s[o].match(i)){t=s.slice(0,parseInt(o)),e=n[1];break}if(!(e&&t&&t.length))return"";{t.reverse();let i=new RegExp(`const ${e} = require\\('(.+?)'`);for(let e of t)if(n=e.match(i))return n[1].replace(/\\\\/g,"\\")}}}function h(t,e){let i=t.stack.split("\n").reverse();for(let t in i){if(" "!=i[t][0]||!e)continue;let n=i[t].match(l);if(n){let o=n[1],l=n[2].split(":"),r=parseInt(l[0]),a=parseInt(l[1]),h={funcName:o,filename:e,line:r-u.line,column:a},d=s.sourceMaps[e][h.line],f=s.cache[e].code;1==h.line&&(h.column=a-u.column),e=c(f,h.line),h.line=d.node.line,h.column=a-d.column+d.node.column,i[t]=`    at ${h.funcName} (${h.filename}`+`:${h.line}:${h.column})`}}return i.reverse(),t.stack=i.join("\n"),t}e.replaceError=h},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(1),s=i(0),o=/([0-9a-zA-Z:\-]+)\s*=\s*|([0-9a-zA-Z:\-]+)\s*/;class l{constructor(t=""){this.listeners={},this.outputTags=l.OutputTags,this.blockTags=l.BlockTags,this.filename=t?s.getAbsPath(t):"undefined",this.renewRegExp(),this.on("block",t=>{let e=t.attributes;if("block"==t.tag)this.blockTags.push(e.name.value),this.renewRegExp();else if("import"==t.tag&&e.target&&e.target.value){let t=e.target.value.split(/,\s*/);for(let e in t){let i=t[e].split(/\s+as\s+/);t[e]=i[1]||i[0]}this.blockTags=this.blockTags.concat(t),this.renewRegExp()}})}renewRegExp(){let t=this.blockTags.join("|"),e="\x3c!--(.*?)--\x3e|\x3c!--(.*)|("+this.outputTags.join("|")+"){(.+?)}|<("+t+")[\\s|\\/|>]|<\\/("+t+")>";this.regexp=new RegExp(e)}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}emit(t,...e){if(!this.listeners[t]||!this.listeners[t].length)return!1;for(let i of this.listeners[t])i(...e);return!0}parse(t){let e={tag:"root",type:"root",line:1,column:1,contents:[],closed:!1};return this.html=t.trimRight().replace(/\r\n|\r/g,"\n"),this.parseHtml(this.html,1,1,e),e}getLine(t,e){let i,n;for(;;){let s=t.indexOf("\n");if(i=(s>=0?t.substring(0,s):t).trimRight(),n=s>=0?t.substring(s+1):"",i||!n)break;e+=1,t=n}return{lineStr:i,left:n,line:e}}attachTextNode(t,e,i,n,s,o=!1){let l={type:"text",line:e,column:i,contents:n?t.substring(0,n):t+"\n",closed:!0};(o||l.contents.trimLeft())&&(s.push(l),this.emit("text",l))}parseHtml(t,e,i=1,s){let o=this.getLine(t,e),r=o.lineStr,a=r.match(this.regexp),u=s.contents;if(t=o.left,e=o.line,a)if(a[1]&&"script"!=s.tag){a.index&&(this.attachTextNode(r,e,i,a.index,u),i+=a.index);let n=r.substring(a.index+a[0].length),s={type:"comment",line:e,column:i,contents:a[0],closed:!1};u.push(s),this.emit("comment",s),n?(t=n+"\n"+t,i+=a[0].length):(s.contents+="\n",e+=1,i=1)}else if(a[2]&&"script"!=s.tag){a.index&&(this.attachTextNode(r,e,i,a.index,u),i+=a.index);let n={type:"comment",line:e,column:i,contents:r.substring(a.index),closed:!1};e+=1,i=1;let s=this.parseComment(t,e,i,n);u.push(n),this.emit("comment",n),t=s.left,e=s.line,i=s.column}else if(a[3]&&a[4]){a.index&&(this.attachTextNode(r,e,i,a.index,u,"!"!=a[3]),i+=a.index),i+=2;let n={tag:a[3],type:"var",line:e,column:i,contents:a[4],closed:!0};u.push(n),this.emit("var",n);let s=a.index+a[4].length+3,o=r.substring(s);o.trimRight()?(t=o+(t?"\n"+t:""),i+=a[4].length+1):(e+=1,i=1)}else if(a[5]&&"script"!=s.tag){a.index&&(this.attachTextNode(r,e,i,a.index,u),i+=a.index);let s=a.index+a[0].length,o=r[s-1],l="/"==o||">"==o,c={tag:a[5],type:"block",line:e,column:i,attributes:{},contents:[],closed:!1};l&&(s-=1);let h=r.substring(s);if(!h&&t){i=1;let n=this.getLine(t,e);n.lineStr&&(h=n.lineStr,t=n.left)}if(!h)throw new n.UnclosedTagError("unclosed tag",this.filename,e,i);t=h+(t?"\n"+t:""),i+=a[0].length,l&&(i-=1);let d=this.applyAttr(t,e,i,c.attributes);c.closed=d.blockClosed,d.left&&!c.closed&&(d=this.parseHtml(d.left,d.line,d.column,c)),u.push(c),this.emit("block",c),t=d.left,e=d.line,i=d.column}else if(a[6]&&a[6]==s.tag){a.index&&"script"!=s.tag&&this.attachTextNode(r,e,i,a.index,u),s.closed=!0;let n=a.index+a[0].length,o=r.substring(n);o?(t=o+(t?"\n"+t:""),i+=n):(e+=1,i=1)}else this.attachTextNode(r,e,i,NaN,u),e+=1,i=1;else{if("script"==s.tag&&s.attributes.engine&&s.attributes.engine.value==l.EngineName){let t={type:"snippet",line:e,column:i,contents:r+"\n",closed:!0};u.push(t),this.emit("snippet",t)}else this.attachTextNode(r,e,i,NaN,u);e+=1,i=1}return t&&!s.closed?this.parseHtml(t,e,i,s):(s.closed=!0,{line:e,column:i,left:t})}applyAttr(t,e,i,s){let l,r,a=this.getLine(t,e),u=a.lineStr,c=u.trimLeft()[0],h="/"==c||">"==c?null:u.match(o);if(e=a.line,t=a.left,!h){let s=u.indexOf(">");if(-1===s)throw new n.UnclosedTagError("unclosed tag",this.filename,e,i);{i+=s+1;let n=u.substring(s+1);n?t=n+"\n"+t:(e+=1,i=1)}return{line:e,column:i,left:t,blockClosed:"/"==c}}let d,f=!0;if(h[1]){let t,e=h.index+h[0].length,n=u[e];(f="'"==n||'"'==n)&&(e+=1),f?t=u.indexOf(n,e):-1===(t=u.indexOf("/",e))&&(t=u.indexOf(">",e)),l=h[1],r=-1===t?"":u.substring(e,t),d=u.substring(t+1),i+=e}else h[2]&&(l=r=h[2].trim(),d=u.substring(h.index+h[0].length),i+=h.index);return s[l]={name:l,value:r,line:e,column:i},d?(t=d+"\n"+t,i+=h[1]?r.length:h[0].length,i+=f?1:0):(e+=1,i=1),this.applyAttr(t,e,i,s)}parseComment(t,e,i,n){let s=this.getLine(t,e),o=s.lineStr,l=o&&o.match(/-->/);if(e=s.line,t=s.left,o&&(n.contents+="\n"),!l)return n.contents+=o,e+=1,i=1,t?this.parseComment(t,e,i,n):{line:e,column:i,left:t};{l.index&&(n.contents+=o.substring(0,l.index)),n.contents+=l[0],n.closed=!0,i+=l.index+3;let s=o.substring(i);s?t=s+"\n"+t:(e+=1,i=1)}return{line:e,column:i,left:t}}}l.EngineName="whatstpl",l.BlockTags=["layout","import","export","block","if","else-if","else","switch","case","default","for","while","do","continue","break","script"],l.OutputTags=["!","@","#"],e.Parser=l},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(s,o){function l(t){try{a(n.next(t))}catch(t){o(t)}}function r(t){try{a(n.throw(t))}catch(t){o(t)}}function a(t){t.done?s(t.value):new i(function(e){e(t.value)}).then(l,r)}a((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(2),o=i(4);var l=null;s.IsBrowser||(l=i(3)),e.CompileOption={encoding:"utf8",cache:!1,removeComments:!1,timeout:5e3,withCredentials:!1,headers:null};class r{constructor(t="",i="utf8"){this.currentLine=0,this.importedModuleCount=0,this.layouts=[],this.filename=t?s.getAbsPath(t):"undefined","string"==typeof i&&(i={encoding:i}),this.options=Object.assign({},e.CompileOption,i)}render(t,e={}){return n(this,void 0,void 0,function*(){return(yield this.compile(t))(e)})}static renderFile(t,e=null,i=null){return n(this,void 0,void 0,function*(){return(yield this.compileFile(t,i))(e||{})})}compile(t){return n(this,void 0,void 0,function*(){if(this.options.cache&&r.cache[this.filename])return r.cache[this.filename];let e=new s.Parser(this.filename).parse(t),i=yield this.createModule(e),n=(t={})=>{try{return i.require(this.filename,t).default.trimRight()}catch(t){throw o.replaceError(t,this.filename)}};return this.options.cache&&(r.cache[this.filename]=n),n})}static compileFile(t,e=null){return n(this,void 0,void 0,function*(){if(t=s.getAbsPath(t),e&&e.cache&&r.cache[t])return r.cache[t];let i=new this(t,e),n=yield i.loadTemplate();return i.compile(n)})}static register(t,e){return new this(t,{cache:!0}).compile(e)}loadTemplate(){return s.IsBrowser?new Promise((t,e)=>{let i=new XMLHttpRequest;if(i.timeout=this.options.timeout,i.withCredentials=this.options.withCredentials,i.open("GET",this.filename,!0),this.options.headers)for(let t in this.options.headers){let e=this.options.headers[t];Array.isArray(e)?e=e.join(", "):"string"!=typeof e&&(e="function"==typeof e.toString?e.toString():String(e)),i.setRequestHeader(t,e)}i.onload=(()=>{t(i.responseText)}),i.onabort=i.onerror=i.ontimeout=(()=>{e(new Error("failed to load remote module."))}),i.send()}):new Promise((t,e)=>{l.readFile(this.filename,this.options.encoding,(i,n)=>{i?e(i):t(n)})})}getAbsPath(t){if(!s.isAbsPath(t)){let e=this.filename&&"undefined"!=this.filename?s.dirname(this.filename):s.getCwd();t=s.normalizePath(e+s.Separator+t)}return s.extname(t)||(t+=s.extname(this.filename)),t}addSourceMap(t,e){this.currentLine+=1,this.module.sourceMap[this.currentLine]={column:t,node:e}}pushCode(t,e,i,n,s=!0){this.module.code+=t+e+i+(s?"\n":""),this.addSourceMap(t.length+1,n)}importModule(t=null){return n(this,void 0,void 0,function*(){if(o.Module.cache[this.filename])return o.Module.cache[this.filename];let e=yield this.loadTemplate(),i=new s.Parser(this.filename).parse(e);return this.createModule(i,t)})}createModule(t,e=null){return n(this,void 0,void 0,function*(){let i=new o.Module(this.filename);if(this.module=i,yield this.attachBlockContents(t),this.layouts.length)for(let{filename:t,node:e}of this.layouts){this.importedModuleCount+=1;let i="__module_"+this.importedModuleCount;t=t.replace(/\\/g,"\\\\"),this.pushCode(`const ${i} = `,`require('${t}', __locals, this.default)`,";",e),this.pushCode("this.default = ",`${i}.default`,";",e)}return i.parent=e,o.Module.cache[this.filename]=i,o.Module.sourceMaps[this.filename]=i.sourceMap,i})}attachBlockContents(t,e=""){return n(this,void 0,void 0,function*(){for(let i of t.contents)if("text"==i.type||"comment"==i.type&&!this.options.removeComments){let t=i.contents.replace(/\n/g,"\\n").replace(/'/g,"\\'");this.pushCode(e+"this.default += '",t,"';",i)}else if("var"==i.type)"!"==i.tag?this.pushCode(e,i.contents,";",i):"@"==i.tag?this.pushCode(e+"this.default += ",i.contents,";",i):this.pushCode(e+"this.default += __escape(",i.contents,");",i);else if("snippet"==i.type){let t=i.contents;this.pushCode(e.substring(4),t,"",i,!1)}else if("block"==i.type)if("import"==i.tag)yield this.attachImport(i,e);else if("export"==i.tag)yield this.attachExport(i,e);else if("block"==i.tag)yield this.attackBlock(i,e);else if("if"==i.tag)yield this.attachIf(i,e);else if("else-if"==i.tag)yield this.attachElseIf(i,e.substring(4));else if("else"==i.tag)yield this.attachElse(i,e.substring(4));else if("switch"==i.tag)yield this.attachSwitch(i,e);else if("case"==i.tag)yield this.attachCase(i,e);else if("default"==i.tag)yield this.attachDefault(i,e);else if("for"==i.tag)yield this.attachFor(i,e);else if("while"==i.tag)yield this.attachWhile(i,e);else if("do"==i.tag)yield this.attachDoWhile(i,e);else if("continue"==i.tag||"break"==i.tag)this.pushCode(e,i.tag,";",i);else if("layout"==i.tag)yield this.attachLayout(i,e);else if("script"==i.tag){let t=i.attributes,n=!t.engine||t.engine.value!=s.Parser.EngineName;if(n){let n="<script";for(let e in t)n+=` ${e}="${t[e].value}"`;n+=">\\n",this.pushCode(e+"this.default += '",n,"';",i)}yield this.attachBlockContents(i,e+"    "),n&&this.pushCode(e+"this.default += '","<\/script>\\n","';",i)}else{let t=i.tag.replace(/-/g,"_"),n=i.attributes;n.await&&"false"!=n.await.value&&(t="await "+t);let s="call(this";n.data&&n.data.value&&(s+=", "+n.data.value),s+=")",this.pushCode(e+t+".",s,";",i)}})}attachLayout(t,e=""){return n(this,void 0,void 0,function*(){let e=this.getAbsPath(t.attributes.file.value);yield new this.constructor(e,this.options).importModule(this.module),this.layouts.push({filename:e,node:t})})}attachImport(t,e=""){return n(this,void 0,void 0,function*(){let i=t.attributes,n=this.getAbsPath(i.from?i.from.value:i.file.value);yield new this.constructor(n,this.options).importModule(this.module),this.importedModuleCount+=1;let s="__module_"+this.importedModuleCount;if(n=n.replace(/\\/g,"\\\\"),this.pushCode(`${e}const ${s} = `,`require('${n}', __locals)`,";",t),i.target&&i.target.value){let n=i.target.value.replace(/-/g,"_").split(/\s*,\s*/);for(let i of n){let n=i.split(/\s*as\s*/),o=n[0],l=n[1]||o;this.pushCode(e,`const ${l} = ${s}.${o}`,";",t)}}else this.pushCode(e,`this.default += ${s}.default`,";",t)})}attachExport(t,e=""){return n(this,void 0,void 0,function*(){if(t.attributes.target&&t.attributes.target.value){let i=t.attributes.target.value.split(/,\s*/);for(let n in i){let s=i[n].split(/\s+as\s+/),o=s[0].replace(/-/g,"_"),l=s[1]?s[1].replace(/-/g,"_"):o;this.pushCode(e,`this.${l} = ${o}`,";",t)}}})}attackBlock(t,e=""){return n(this,void 0,void 0,function*(){let i=t.attributes,n=i.name.value.replace(/-/g,"_"),s=`function ${n}(`;i.async&&"false"!=i.async.value&&(s="async "+s),i.params&&i.params.value&&(s+=i.params.value),s+=")",this.pushCode(e,s," {",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e,"","}",t),i.export&&"false"!=i.export.value&&this.pushCode(e,`this.${n} = ${n}`,";",t)})}attachIf(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"if (",t.attributes.condition.value,") {",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e,"","}",t)})}attachElseIf(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"} else if (",t.attributes.condition.value,") {",t),yield this.attachBlockContents(t,e+"    ")})}attachElse(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"} else {","","",t),yield this.attachBlockContents(t,e+"    ")})}attachSwitch(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"switch (",t.attributes.target.value,") {",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e,"","}",t)})}attachCase(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"case ",t.attributes.data.value,":",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e+"    ","break",";",t)})}attachDefault(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"default","",":",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e+"    ","break",";",t)})}attachFor(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"for (",t.attributes.statement.value,") {",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e,"","}",t)})}attachWhile(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"while (",t.attributes.condition.value,") {",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e,"","}",t)})}attachDoWhile(t,e=""){return n(this,void 0,void 0,function*(){this.pushCode(e+"do ",""," {",t),yield this.attachBlockContents(t,e+"    "),this.pushCode(e+"} while (",t.attributes.while.value,");",t)})}}r.cache={},e.Template=r,e.default=r}])});
//# sourceMappingURL=whatstpl.min.js.map